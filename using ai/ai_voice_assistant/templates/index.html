<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
    <style>
        .chat-container {
            height: 70vh;
            overflow-y: auto;
        }
        .user-message {
            background-color: #e3f2fd;
            border-radius: 1rem 1rem 0 1rem;
        }
        .assistant-message {
            background-color: #f5f5f5;
            border-radius: 1rem 1rem 1rem 0;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .typing-indicator div {
            animation: bounce 1s infinite ease-in-out;
        }
        .error-message {
            color: #e53e3e;
            font-style: italic;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-600 mb-2">AI Voice Assistant</h1>
            <p class="text-gray-600">Speak or type your request below</p>
        </div>
        
        <div id="connection-status" class="text-center mb-4 hidden">
            <span class="inline-block w-3 h-3 rounded-full bg-yellow-500 mr-2"></span>
            <span class="text-sm text-gray-600">Connecting...</span>
        </div>
        
        <div id="chat-container" class="bg-white rounded-xl shadow-lg p-6 mb-6 h-[60vh] overflow-y-auto flex flex-col space-y-4">
            <div class="assistant-message p-4 max-w-xs md:max-w-md lg:max-w-lg xl:max-w-xl mx-4 my-2 self-start">
                <p class="font-medium text-gray-800">Ava</p>
                <p class="text-gray-700">I'm ready to help you. What can I do for you?</p>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-4">
            <div class="flex items-center">
                <input type="text" id="user-input" 
                       class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="Type your message here..."
                       autocomplete="off">
                <button id="send-button" 
                        class="bg-blue-500 text-white px-6 py-3 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button id="mic-button" 
                        class="ml-2 bg-gray-100 text-gray-700 p-3 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 transition-colors">
                    <i class="fas fa-microphone text-xl"></i>
                </button>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <script>
        // Initialize Socket.IO with connection timeout and better error handling
        let socket;
        
        function initializeSocket() {
            socket = io({
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                timeout: 10000,
                transports: ['websocket', 'polling']
            });
            
            // Connection established
            socket.on('connect', () => {
                console.log('Connected to server');
                updateConnectionStatus('connected');
                // Send a test message to verify the connection
                socket.emit('test_connection', { timestamp: Date.now() });
            });
            
            // Connection error
            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                updateConnectionStatus('error');
                // Try to reconnect after a delay
                setTimeout(initializeSocket, 5000);
            });
            
            // Disconnected
            socket.on('disconnect', (reason) => {
                console.log('Disconnected:', reason);
                updateConnectionStatus('disconnected');
                if (reason === 'io server disconnect') {
                    // The server forcibly closed the connection, try to reconnect
                    socket.connect();
                }
            });
            
            // Handle test connection response
            socket.on('test_connection_response', (data) => {
                console.log('Server connection verified:', data);
            });
        }
        
        // Update connection status UI
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connection-status');
            const statusDot = statusElement.querySelector('span');
            const statusText = statusElement.querySelector('span:last-child');
            
            statusElement.classList.remove('hidden');
            
            switch(status) {
                case 'connected':
                    statusDot.className = 'inline-block w-3 h-3 rounded-full bg-green-500 mr-2';
                    statusText.textContent = 'Connected';
                    break;
                case 'connecting':
                    statusDot.className = 'inline-block w-3 h-3 rounded-full bg-yellow-500 mr-2';
                    statusText.textContent = 'Connecting...';
                    break;
                case 'disconnected':
                    statusDot.className = 'inline-block w-3 h-3 rounded-full bg-red-500 mr-2';
                    statusText.textContent = 'Disconnected. Reconnecting...';
                    break;
                case 'error':
                    statusDot.className = 'inline-block w-3 h-3 rounded-full bg-red-500 mr-2';
                    statusText.textContent = 'Connection error. Retrying...';
                    break;
            }
        }
        
        // Initialize the socket connection
        updateConnectionStatus('connecting');
        initializeSocket();
        
        // DOM Elements
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const micButton = document.getElementById('mic-button');
        const connectionStatus = document.getElementById('connection-status');
        const errorMessage = document.getElementById('error-message');
        const recordingIndicator = document.getElementById('recording-indicator');
        
        // Check if browser supports speech recognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isListening = false;
        
        // Initialize speech recognition if available
        function initSpeechRecognition() {
            if (!SpeechRecognition) {
                console.warn('Speech recognition not supported in this browser');
                micButton.disabled = true;
                micButton.title = 'Speech recognition not supported in your browser';
                return false;
            }
            
            try {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onstart = () => {
                    isListening = true;
                    micButton.classList.add('bg-red-500', 'text-white');
                    micButton.classList.remove('bg-gray-100', 'text-gray-700');
                    recordingIndicator.classList.remove('hidden');
                    userInput.placeholder = 'Listening...';
                };
                
                recognition.onend = () => {
                    isListening = false;
                    micButton.classList.remove('bg-red-500', 'text-white');
                    micButton.classList.add('bg-gray-100', 'text-gray-700');
                    recordingIndicator.classList.add('hidden');
                    userInput.placeholder = 'Type your message here...';
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    if (transcript.trim()) {
                        userInput.value = transcript;
                        sendMessage();
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    showError('Error with speech recognition. Please try again.');
                };
                
                return true;
            } catch (error) {
                console.error('Error initializing speech recognition:', error);
                showError('Could not initialize speech recognition');
                return false;
            }
        }
        
        // Toggle speech recognition
        function toggleSpeechRecognition() {
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    return;
                }
            }
            
            try {
                if (isListening) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            } catch (error) {
                console.error('Microphone access error:', error);
                showError('Could not access microphone. Please check permissions.');
            }
        }
        
        // Initialize speech recognition on page load
        document.addEventListener('DOMContentLoaded', () => {
            initSpeechRecognition();
            
            // Set focus to input field
            userInput.focus();
            
            // Show initial connection status
            connectionStatus.classList.remove('hidden');
            
            // Set up event listeners
            micButton.addEventListener('click', toggleSpeechRecognition);
            sendButton.addEventListener('click', sendMessage);
            
            // Send message on Enter key
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });
        
        // Handle incoming messages from the server
        socket.on('assistant_message', (data) => {
            // Remove typing indicator
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
            
            if (data && data.message) {
                addMessage('assistant', data.message);
                
                // Speak the response if speech synthesis is available
                if ('speechSynthesis' in window) {
                    try {
                        const utterance = new SpeechSynthesisUtterance(data.message);
                        utterance.rate = 1.0;
                        utterance.pitch = 1.0;
                        window.speechSynthesis.speak(utterance);
                    } catch (e) {
                        console.error('Error with speech synthesis:', e);
                    }
                }
            } else {
                console.error('Received invalid message format:', data);
                showError('Error: Invalid response from server');
            }
        });
        
        // Handle connection status
        socket.on('connect', () => {
            console.log('Connected to server');
            connectionStatus.classList.add('hidden');
            errorMessage.classList.add('hidden');
        });
        
        socket.on('disconnect', (reason) => {
            console.log('Disconnected from server:', reason);
            connectionStatus.classList.remove('hidden');
            connectionStatus.querySelector('span:last-child').textContent = 'Disconnected. Trying to reconnect...';
            
            if (reason === 'io server disconnect') {
                // The server has forcefully disconnected the socket
                showError('Disconnected from server. Please refresh the page.');
            }
        });
        
        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            connectionStatus.classList.remove('hidden');
            connectionStatus.querySelector('span:last-child').textContent = 'Connection error. Trying to reconnect...';
            showError('Connection error. Please check your internet connection.');
        });
        
        // Send message to the server
        function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            // Add user message to chat
            addMessage('user', message);
            userInput.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Send message to server with timeout
            const timeout = setTimeout(() => {
                showError('Server is taking too long to respond. Please try again.');
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
            }, 30000); // 30 seconds timeout
            
            socket.emit('user_message', { message }, (response) => {
                clearTimeout(timeout);
                
                // Remove typing indicator
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
                
                if (response && response.error) {
                    showError(response.error);
                }
            });
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.className = 'flex justify-start';
            typingIndicator.innerHTML = `
                <div class="assistant-message p-4 max-w-xs md:max-w-md lg:max-w-lg xl:max-w-xl mx-4 my-2">
                    <div class="typing-indicator flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(typingIndicator);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            userInput.focus();
        }
        
        // Add a message to the chat
        function addMessage(sender, message) {
            const messageDiv = document.createElement('div');
            const isUser = sender === 'user';
            
            messageDiv.className = `p-4 max-w-xs md:max-w-md lg:max-w-lg xl:max-w-xl mx-4 my-2 rounded-xl ${
                isUser 
                    ? 'bg-blue-500 text-white self-end rounded-br-none' 
                    : 'bg-gray-100 text-gray-800 self-start rounded-bl-none'
            }`;
            
            if (!isUser) {
                const name = document.createElement('p');
                name.className = 'font-medium text-sm mb-1';
                name.textContent = 'Ava';
                messageDiv.appendChild(name);
            }
            
            const content = document.createElement('div');
            content.className = isUser ? 'text-white' : 'text-gray-700';
            content.textContent = message;
            messageDiv.appendChild(content);
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Show error message
        function showError(message) {
            errorMessage.querySelector('span').textContent = message;
            errorMessage.classList.remove('hidden');
            
            // Auto-hide error after 5 seconds
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }
        
        // Start the conversation
        socket.emit('start_listening');
    </script>
</body>
</html>
